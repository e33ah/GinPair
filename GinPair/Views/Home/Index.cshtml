@model GinPair.Models.PairingVM

@{
	ViewData["Title"] = "Home";
}

<div class="container text-center mt-5">
	<h1 class="display-4 pt-3">Welcome to Gin Pair</h1>
	<p class="mt-4">
		Your ultimate guide to the perfect gin and tonic pairing!<br>
		Find your favourite gin, and we'll show you the perfect tonic pairing.
	</p>
	<form asp-action="Index" method="get" class="row d-flex flex-row align-items-center mb-2 justify-content-center">
		<div class="col-12 col-md-8 col-lg-4 py-1">
			<input id="ginSearchBox" type="text" name="searchString" placeholder="Start typing a gin..." value="@ViewData["CurrentFilter"]" class="form-control p-2" />
			<input id="ginSelectedId" type="hidden" name="searchId" />
		</div>
		<div class="col-auto py-1">
			<button id="ginSearchButton" type="button" class="btn btn-primary">Search</button>
		</div>
	</form>
	<div id="searchResult" class="container mt-4 col-12 col-md-6 col-lg-6"></div>
</div>


@section Scripts
{
	<script type="text/javascript">
		// Validate input
		document.getElementById("ginSearchBox").addEventListener("input", function (e) {
			var regex = /^[a-zA-Z0-9'& ]*$/;
			var input = e.target.value;
			if (!regex.test(input))
			{
				e.target.value = input.slice(0, -1);
			}
		});
		// Reset message
		function ResetMessage() {
			document.getElementById("searchResult").innerText = "";
			$("#searchResult").removeClass("alert alert-primary alert-success alert-warning alert-danger");
		}
		document.getElementById("ginSearchBox").addEventListener("click", ResetMessage);

		// Enable enter key to trigger search
		document.getElementById("ginSearchBox").addEventListener("keypress", function(event){
			if(event.key === "Enter"){
				event.preventDefault();
				document.getElementById("ginSearchButton").focus();
				document.getElementById("ginSearchButton").click();
			}
		});
		// Auto complete gin as user types
		$(document).ready(function(){
			$("#ginSearchBox").autocomplete({
				source: function(request, response){
					$.ajax({
						url: "/api/ginapi/matchGin",
						type: "GET",
						data: { partial: request.term },
						success: function(data) {
							response($.map(data, function(item) {
								return{
									label: item.distillery + " " + item.ginName,
									value: item.distillery + " " + item.ginName,
									id: item.ginId
								};
							}));
						},
						error: function(xhr, status, error) {
							if (xhr.status === 503) {
								$("#searchResult").text("Hang tight! We're getting things ready. Please try again in a minute.").addClass("alert alert-danger");
							} else {
								$("#searchResult").text("An error occurred: " + error).addClass("alert alert-danger");
							}
						}
					});
				},
				minLength: 2,
				autoFocus: true,
				select: function(event, ui) {
					selectedId = ui.item.id;
					$("#ginSelectedId").val(selectedId);
				}
			});
		});
		// Use ginId to get pairing
		$("#ginSearchButton").click(function() {
			var ginSearchBoxValue = $("#ginSearchBox").val();
			var ginSelectedId = $("#ginSelectedId").val();
			if(ginSelectedId){
				$.ajax({
					url: "/api/ginapi/getPairing/" + ginSelectedId,
					type: "GET",
					success: function(response){
						$("#searchResult").html(response.statusMessage);
						switch(response.bsColor){
							case 0:
								$("#searchResult").addClass("alert alert-primary");
								break;
							case 1:
								$("#searchResult").addClass("alert alert-success");
								break;
							case 2:
								$("#searchResult").addClass("alert alert-warning");
								break;
							case 3:
								$("#searchResult").addClass("alert alert-danger");
								break;
						}
					},
					error: function(xhr, error) {
						if (xhr.status === 503) {
							$("#searchResult").text("Hang tight! We're getting things ready. Please try again in a minute.").addClass("alert alert-danger");
						} else {
							$("#searchResult").text("An error occurred: " + error + ". Please try again.").addClass("alert alert-danger");
						}
					}
				});
			} else if (!ginSearchBoxValue || ginSearchBoxValue.trim() === "") {
				$("#searchResult").text("Enter the name of a gin and hit Search").addClass("alert alert-warning");
			} else {
				$("#searchResult").text("No matching gin found. Please try a another gin.").addClass("alert alert-warning");
			}
		});
	</script>
}